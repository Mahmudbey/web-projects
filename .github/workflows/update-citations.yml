name: Update Academic Stats (Scholar & Scopus)

on:
  schedule:
    - cron: "0 0 * * 1" # Har dushanba
    - cron: "0 0 * * 4" # Har payshanba
  workflow_dispatch: # Manuel ishga tushirish tugmasi

jobs:
  update-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests PyYAML scholarly

      - name: Fetch and Merge Academic Data
        env:
          SCOPUS_API_KEY: ${{ secrets.SCOPUS_API_KEY }}
          SCOPUS_ID: "57432107100"
          SCHOLAR_ID: "wd7-ywQAAAAJ"
        run: |
          python -c "
          import requests
          import yaml
          import os
          from scholarly import scholarly

          stats = {'scopus': {}, 'scholar': {}}

          # 1. Scopus ma'lumotlarini olish
          try:
              scopus_url = f'https://api.elsevier.com/content/author/author_id/{os.environ[\"SCOPUS_ID\"]}'
              headers = {'X-ELS-APIKey': os.environ['SCOPUS_API_KEY'], 'Accept': 'application/json'}
              r = requests.get(scopus_url, headers=headers)
              if r.status_code == 200:
                  data = r.json()['author-retrieval-response'][0]['coredata']
                  stats['scopus'] = {
                      'h_index': int(data.get('h-index', 0)),
                      'citations': int(data.get('citation-count', 0)),
                      'documents': int(data.get('document-count', 0))
                  }
                  print('Scopus data updated.')
          except Exception as e:
              print(f'Scopus error: {e}')

          # 2. Google Scholar ma'lumotlarini olish
          try:
              search_query = scholarly.search_author_id(os.environ['SCHOLAR_ID'])
              author = scholarly.fill(search_query, sections=['basics', 'indices'])
              stats['scholar'] = {
                  'h_index': author.get('hindex', 0),
                  'citations': author.get('citedby', 0),
                  'i10_index': author.get('i10index', 0)
              }
              print('Scholar data updated.')
          except Exception as e:
              print(f'Scholar error: {e}')

          # Ma'lumotlarni _data/stats.yml fayliga saqlash
          os.makedirs('_data', exist_ok=True)
          with open('_data/stats.yml', 'w') as f:
              yaml.dump(stats, f, default_flow_style=False)
          "

      - name: Commit and push changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add _data/stats.yml
          git diff --staged --quiet || (git commit -m "Update Scholar & Scopus stats" && git push)
